version: "{build}"

os: Windows Server 2012 R2

clone_folder: c:\gopath\src\github.com\wellington\wellington

platform:
  - x64

environment:
  global:
    MSYS_BASEBER: 20150512
    GOPATH: c:\gopath
    WIN_VER: windows-na
    CGO_ENABLED: 1
    GOROOT_BOOTSTRAP: C:\go
    GOROOT: C:\go15\go
  matrix:
    MSYS2_ARCH: x86_64

install:
  # install nodejs and npm
  # - ps: Install-Product node $env:nodejs_version

  - appveyor DownloadFile "http://kent.dl.sourceforge.net/project/msys2/Base/%MSYS2_ARCH%/msys2-base-%MSYS2_ARCH%-%MSYS2_BASEVER%.tar.xz" -FileName "msys2.tar.xz"
  - 7z x msys2.tar.xz
  - 7z x msys2.tar > NUL
  - msys64\usr\bin\bash -lc ""
  - msys64\usr\bin\bash -lc "for i in {1..3}; do pacman --noconfirm -Suy mingw-w64-%MSYS2_ARCH%-{ragel,freetype,icu,gettext} libtool pkg-config gcc make autoconf automake perl && break || sleep 15; done"
  - set PATH=C:\go15\go\bin;C:\gopath\bin;%PATH%
  - set CC=gcc
  - set CXX=g++
  - echo %PATH%
  - echo %GOPATH%
  #retrieve go 1.5
  - ps: |
      $file = "go1.5beta1.windows-amd64.zip"
      $url  = "https://storage.googleapis.com/golang/"
      $url += $file
      Invoke-WebRequest -UserAgent wget -Uri $url -OutFile go1.5beta1.windows-amd64.zip
      &7z x -oC:\go15 go1.5beta1.windows-amd64.zip > $null
  - dir C:\go15
  - go version
  - go get github.com/tools/godep
  - go get github.com/laher/goxc
  - godep restore

build_script:
  - msys64\usr\bin\bash -lc "cd $APPVEYOR_BUILD_FOLDER; PATH=$PATH:/mingw64/bin:/mingw32/bin; exec 0</dev/null; make windows;"
after_build:
  - 7z a wt_windows_amd64.zip wt.exe
artifacts:
  - path: wt_windows_amd64.zip
    name: wt_windows_amd64.zip
